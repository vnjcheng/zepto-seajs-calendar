define(function(require,exports,module){var $=require("zepto");function Calendar(options){this._init(options)}var fn={_init:function(options){this.settings=extend(config,options);this.canBeSelected=this._canBeSelected();this._showCalendar();this._bindEvent()},_showCalendar:function(){var render=[];var curDate=this.curDate=new Date;for(var i=0;i<this.settings.display;i++){render.push(this._render(curDate.getFullYear(),curDate.getMonth()+i))}$(this.settings.el).append('<div class="tn-container">'+render.join("")+"</div>")},_render:function(y,m){var thead=['<div class="tn-item-container"><div class="tn-c-header"><span class="tn-c-title">',"","</span></div>"];var ths=['<div class="tn-c-body"><table>','<tr class="tn-c-week">',"<th>日</th>","<th>一</th>","<th>二</th>","<th>三</th>","<th>四</th>","<th>五</th>","<th>六</th>","</tr>"];var cbody=this._getTds(y,m);thead[1]=cbody.thead;ths=ths.concat(cbody.trs);ths.push("</table></div></div>");return thead.concat(ths).join("")},_getTds:function(y,m){var date=new Date(y,m,1);var fday=date.getDay();date=new Date(y,m+1,0);var aday=date.getDate(),ayear=date.getFullYear(),amonth=date.getMonth();var tds=["<tr>"],trs=[];var iday,curday,curDate=this.curDate,dateArea=this.canBeSelected,stop=false;for(var i=1;i<=42;i++){iday=i-fday;curday=ayear+"-"+(amonth<9?"0":"")+(amonth+1)+"-"+(iday<=9?"0":"")+iday;if(i>fday&&i<=aday+fday){if(iday===curDate.getDate()&&ayear===curDate.getFullYear()&&amonth==curDate.getMonth()){if(dateArea.length&&dateArea.indexOf(curday)==-1){tds.push('<td class="today disabled" data-date="'+curday+'">今天</td>')}else{tds.push('<td class="today" data-date="'+curday+'">今天</td>')}}else if(dateExtend.compare(curDate,curday)>0||dateArea.length&&dateArea.indexOf(curday)==-1){tds.push('<td class="disabled" data-date="'+curday+'">'+iday+"</td>")}else{tds.push('<td data-date="'+curday+'">'+iday+"</td>")}}else if(!stop){tds.push("<td></td>")}if(i%7===0&&!stop){tds.push("</tr>");trs=trs.concat(tds);if(i>=aday+fday){stop=true}!stop&&(tds=["<tr>"])}}var months=["一","二","三","四","五","六","七","八","九","十","十一","十二"];var thead=months[amonth]+"月&nbsp;&nbsp;&nbsp;&nbsp;"+ayear;return{trs:trs,thead:thead}},_canBeSelected:function(){var canSelsArr=[],canBeSels=this.settings.canBeSelected;if(!canBeSels){return canSelsArr}canSelsArr=canBeSels.split(",");var splitStr=this.settings.splitStr;canSelsArr.forEach(function(item,i){var area=item.split(splitStr);if(area.length==1){return}var min=area[0],max=area[1];if(dateExtend.compare(min,max)>0){min=area[1];max=area[0]}var tem=new Date(min);while(dateExtend.compare(tem,max)<=0){var fmtDate=dateExtend.format(tem,"YYYY-MM-DD");canSelsArr.indexOf(fmtDate)===-1&&canSelsArr.push(fmtDate);tem=dateExtend.add(tem,1)}canSelsArr.splice(i,1)});return canSelsArr},_bindEvent:function(){var _this=this;var el=$(this.settings.el),type=this.settings.type,dateArea=parseInt(this.settings.dateArea,10);var tds=el.find("td");tds.off("click").on("click",function(e){var node=$(e.target),date=node.attr("data-date");if(node.hasClass("disabled")){return}if(type=="single"){el.find(".selected").removeClass("selected")}else if(type=="multiple"){var selected=_this._getSelectedDate();var days=dateExtend.compare(date,selected)/24/60/60/1e3;if(selected.length>=2||selected.length==1&&(days>dateArea||days<0)){el.find(".selected").find("p").remove();el.find(".selected").removeClass("selected")}el.find(".beselected").removeClass("beselected")}$(this).addClass("selected");var beSelected=_this._getSelectedDate();if(type=="multiple"&&beSelected.length==2){var arr=[];var min=beSelected[0],max=beSelected[1];var tem=new Date(min);while(dateExtend.compare(tem,max)<0){tem=dateExtend.add(tem,1);var fmtDate=dateExtend.format(tem,"YYYY-MM-DD");arr.push(fmtDate)}arr.forEach(function(item){el.find('[data-date="'+item+'"]').not(".disabled").not(".selected").addClass("beselected")})}var bc=_this.settings.bottom_center;if(bc&&typeof bc=="function"){bc=bc.call(_this,e)}$(node).append(bc?"<p>"+bc+"</p>":"");var callback=_this.settings.callback;if(callback&&typeof callback=="function"){callback.call(_this,e)}})},_getSelectedDate:function(){var el=$(this.settings.el),selNodes=el.find(".selected");var arr=[];selNodes.each(function(i,item){arr.push($(item).attr("data-date"))});return arr},getSelectedDate:function(){var type=this.settings.type,dates=this._getSelectedDate();if(type=="single"){return dates[0]}else{return dates}},setSelectedDate:function(dates){var type=this.settings.type,el=$(this.settings.el);var datesArr=dates.split(",");datesArr.forEach(function(item,i){el.find('[data-date="'+item+'"]').click()});return this},load:function(data){var el=$(this.settings.el);if(!data){return}data.forEach(function(item,i){if(!$('td[data-date="'+item.date+'"]',el).hasClass("disabled")){$('td[data-date="'+item.date+'"]',el).append('<p class="price">'+item.price+"</p>")}})}};var extend=function(dest,src){if(dest&&typeof dest=="object"&&src&&typeof src=="object"){for(var i in src){if(src[i]){dest[i]=src[i]}}}return dest};extend(Calendar.prototype,fn);var config={display:1,canBeSelected:"",type:"single",callback:function(){},el:document.body,splitStr:"~",bottom_center:function(){if(this.settings.type=="multiple"){if(this._getSelectedDate().length==1){return"出发"}else{return"离开"}}else{return""}},dateArea:29};var dateExtend={};dateExtend.add=function(date,day){return new Date(+new Date(date)+(parseInt(day,10)||0)*24*60*60*1e3)};dateExtend.format=function(date,fmt){date=new Date(date);var o={"M+":date.getMonth()+1,"D+":date.getDate(),"h+":date.getHours(),"m+":date.getMinutes(),"s+":date.getSeconds(),"q+":Math.floor((date.getMonth()+3)/3),S:date.getMilliseconds()};if(/(Y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(date.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length))}}return fmt};dateExtend.compare=function(date,odate){return+new Date(date)-(+new Date(odate)||0)};module.exports=Calendar});